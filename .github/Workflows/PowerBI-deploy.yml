name: CI / Deploy

on:
  push:
    branches:
      - main
      - dev

  # Optional: keep manual trigger if you need to re-run manually sometimes
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # Environment + secrets protection (optional but recommended for prod)
    # Uncomment and create environments in repo settings if needed
    # environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Example: Azure login using your repository secrets
      # (uncomment/adapt based on what you actually need — e.g. az cli, Power Platform, etc.)
      - name: Azure Login
        if: always()  # or remove if not needed
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.CLIENT_ID }}
          client-secret: ${{ secrets.CLIENT_SECRET }}
          tenant-id: ${{ secrets.TENANT_ID }}

      # Example: If you need to use DEVWORKSPACEID (e.g. Power Platform / DevOps workspace)
      - name: Show workspace ID (example)
        run: |
          echo "Using Dev Workspace ID: ${{ secrets.DEVWORKSPACEID }}"

      # ────────────────────────────────────────────────
      #   ← Replace these placeholder steps with your real build / test / deploy commands →
      # ────────────────────────────────────────────────
      - name: Setup your environment (example)
        run: |
          echo "Install dependencies, build your app here..."
          # npm ci
          # dotnet restore
          # etc.

      - name: Build
        run: |
          echo "Building the project..."
          # npm run build
          # dotnet build
          # etc.

      - name: Test
        run: |
          echo "Running tests..."
          # npm test
          # dotnet test
          # etc.

      - name: Deploy to ${{ github.ref_name == 'main' && 'Production' || 'Dev/Staging' }}
        run: |
          echo "Deploying to ${{ github.ref_name }} branch environment..."
          echo "Using CLIENT_ID = ${{ secrets.CLIENT_ID }}"
          echo "Using TENANT_ID = ${{ secrets.TENANT_ID }}"
          echo "Using DEVWORKSPACEID = ${{ secrets.DEVWORKSPACEID }}"
          
          # Your real deployment commands here, examples:
          # az deployment group create --resource-group my-rg ...
          # pac auth create --url https://... --clientid ${{ secrets.CLIENT_ID }} ...
          # npm run deploy
          # etc.

      # Optional: Notify or cleanup
      - name: Workflow summary
        if: always()
        run: |
          echo "Workflow finished for ${{ github.ref_name }} (commit: ${{ github.sha }})"