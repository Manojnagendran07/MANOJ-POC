name: Deploy Power BI Reports

on:
  push:
    branches:
      - main
      - feature

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Power BI CLI
        run: npm install -g @powerbi-cli/powerbi-cli
        shell: pwsh

      - name: Authenticate with Power BI
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          TENANT_ID: ${{ secrets.TENANT_ID }}
        run: |
          pbicli login --service-principal --principal "$env:CLIENT_ID" --secret "$env:CLIENT_SECRET" --tenant "$env:TENANT_ID"
        shell: pwsh

      - name: Select Workspace
        id: set-workspace
        run: |
          $branch = "${{ github.ref_name }}"
          switch ($branch) {
            'main'    { $workspaceId = "${{ secrets.WORKSPACE_ID_PROD }}" }
            'feature' { $workspaceId = "${{ secrets.WORKSPACE_ID_DEV }}" }
          }
          echo "workspaceId=$workspaceId" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Publish PBIX files
        run: |
          $ws = "${{ steps.set-workspace.outputs.workspaceId }}"
          $files = Get-ChildItem -Path . -Recurse -Filter *.pbix
          foreach ($file in $files) {
            pbicli import pbix -w $ws --file "$file" --conflict CreateOrOverwrite
          }
        shell: pwsh
